# script_kit 开发计划

**项目**：脚本管理与执行标准件（script_kit）  
**根目录**：`G:\cursor\projects\script_kit`  
**参考需求**：同目录 `脚本管理与执行标准件-需求说明书.md`  
**参考代码**：`G:\django\Article\脚本管理\代码备份\20251118\script_manager`

---

## 预计总时长

**约 1～2 个工作日（合计 8～12 小时）**，视联调与调试情况浮动。各阶段预估见下。

---

## 阶段 0：仓库与环境（优先执行）

**预估**：约 0.5～1 小时

### 0.1 Git 仓库

| 步骤 | 内容 |
|------|------|
| 0.1.1 | 在 `G:\cursor\projects\script_kit` 下执行 `git init`，建立仓库。 |
| 0.1.2 | 新增 **.gitignore**：排除 `venv/`、`__pycache__/`、`*.pyc`、`.env`、`db.sqlite3`（若不想提交）、`*.log`、`.idea/`、`*.egg-info/` 等。 |
| 0.1.3 | 可选：初始提交（如「chore: init script_kit repo」）。 |

### 0.2 环境依赖与 Docker

| 步骤 | 内容 |
|------|------|
| 0.2.1 | **requirements.txt**：在项目根或 `demo_project/` 下列出 Django 及 script_kit 运行所需依赖（如 `Django>=4.x`），便于 venv 与 Docker 共用。 |
| 0.2.2 | **Docker 支持**：为 **demo_project** 提供 **Dockerfile**（如基于 `python:3.11-slim`，安装 requirements，拷贝代码，暴露端口，CMD 跑 runserver）；可选 **docker-compose.yml**（挂载目录、映射端口、一键 up）。在阶段 1 搭好 demo_project 后补全。 |
| 0.2.3 | 接入文档（阶段 7）中补充：本地 venv 安装方式、Docker 构建与运行方式。 |

---

## 阶段 1：骨架与配置

**预估**：约 1 小时

| 步骤 | 内容 |
|------|------|
| 1.1 | 创建标准件目录 `script_kit/`：`__init__.py`, `apps.py`, `models.py`, `views.py`, `urls.py`, `admin.py`，AppConfig 名为 script_kit。 |
| 1.2 | `script_kit/` 下建 `templates/script_kit/`、`scripts/`（两子目录，先空或仅 `__init__.py`）。 |
| 1.3 | 建测试用 Django 项目 `demo_project/`：`manage.py`、`demo_project/settings.py`、`demo_project/urls.py`，INSTALLED_APPS 加 `script_kit`，根 url 挂载 `path('script-kit/', include('script_kit.urls'))`。 |
| 1.4 | `demo_project/settings.py` 增加 `SCRIPT_KIT_SCRIPTS_ROOT = 'script_kit.scripts'`；标准件内从 settings 读取，未配置时用该默认值。 |

**验收**：`python manage.py runserver` 能启动，访问 `/script-kit/` 不 500。

---

## 阶段 2：数据模型与迁移

**预估**：约 0.5～1 小时

| 步骤 | 内容 |
|------|------|
| 2.1 | **ScriptDefinition**：在参考基础上增加 `default_parameters`（JSONField，default=dict，blank=True）。表名 `script_kit_definition`。 |
| 2.2 | **ScriptExecution**：与参考一致，表名 `script_kit_execution`。 |
| 2.3 | **ScriptParameterPreset**：script（FK）、name、parameters（JSON）、created_at、updated_at；同一 script 下 name 唯一；表名 `script_kit_parameter_preset`。 |
| 2.4 | 在 demo_project 下执行 `makemigrations script_kit`、`migrate`。 |

**验收**：迁移无报错，能创建/查询上述模型。

---

## 阶段 3：配置化脚本根路径

**预估**：约 0.5 小时

| 步骤 | 内容 |
|------|------|
| 3.1 | 在 script_kit 中实现 `get_scripts_root()`，从 `settings.SCRIPT_KIT_SCRIPTS_ROOT` 读取，默认 `'script_kit.scripts'`。 |
| 3.2 | 所有按 script_file 动态 import 处改为 `importlib.import_module(f'{root}.{script_def.script_file}')`。 |
| 3.3 | 扫描分类/按分类列 .py 文件的逻辑改为基于该 root。 |

**验收**：修改配置后能正确导入并执行脚本（可与阶段 5 一起验）。

---

## 阶段 4：后端 API

**预估**：约 2～3 小时

| 步骤 | 内容 |
|------|------|
| 4.1 | 沿用参考 API（执行页/管理页、scripts 列表与创建、script 详情/更新/删除、execute、scripts-list、execution、categories、script-files、import/export），实现时用 script_kit 模型与配置化 root。 |
| 4.2 | 缺省参数：GET/PUT（或 POST）`api/script/<id>/default-parameters/`。 |
| 4.3 | 参数预设：GET/POST `api/script/<id>/presets/`，GET/PUT/DELETE `api/script/<id>/presets/<preset_id>/`。 |
| 4.4 | 执行接口：params 原样传入 `main(params)`（含 dry_run）。 |
| 4.5 | 预留：`POST api/execute-by-description/`、`POST api/query-by-description/` 返回 501 及约定说明。 |

**验收**：API 能调通（执行可等有脚本后验）。

---

## 阶段 5：前端（执行页 + 管理页）

**预估**：约 2～3 小时

| 步骤 | 内容 |
|------|------|
| 5.1 | 执行页：选择脚本后拉取 default-parameters 填表单；试运行勾选传 dry_run；执行后可选「保存为缺省参数」；加载预设、保存为预设。 |
| 5.2 | 管理页：脚本编辑中可编辑缺省参数；脚本详情/编辑中管理参数预设。 |
| 5.3 | 模板与静态命名空间为 script_kit，API 前缀与 url 挂载一致。 |

**验收**：执行页与管理页功能符合需求。

---

## 阶段 6：测试脚本与初始化数据

**预估**：约 1～1.5 小时

| 步骤 | 内容 |
|------|------|
| 6.1 | `script_kit/scripts/` 下建 `file_operations/`、`data_processing/`，各含 `__init__.py`。 |
| 6.2 | file_operations：至少 2 个脚本，实现 `main(params)`，返回 status、message 等。 |
| 6.3 | data_processing：至少 2 个脚本，至少 1 个支持 dry_run（检查 params.get('dry_run')）。 |
| 6.4 | 提供 management command 或 fixture，初始化至少 4 条 ScriptDefinition。 |

**验收**：执行页有两类、每类至少 2 个脚本；能执行；试运行行为正确。

---

## 阶段 7：接入文档与收尾

**预估**：约 1 小时

| 步骤 | 内容 |
|------|------|
| 7.1 | 编写接入文档：INSTALLED_APPS、url 挂载、SCRIPT_KIT_SCRIPTS_ROOT、脚本目录与 main(params)/dry_run 约定；本地 venv 与 Docker 使用说明。 |
| 7.2 | 需求说明书中可加一句「标准件实现名：script_kit」（可选）。 |
| 7.3 | 整体检查：demo_project 全流程跑通；按接入文档可接入新项目。 |

---

## 执行顺序

- **先做阶段 0**，再按 1 → 2 → 3 → 4 → 5 → 6 → 7 顺序执行。
- 阶段 4 依赖 2、3；阶段 5 依赖 4；阶段 6 可与 4/5 穿插，验收依赖 5；阶段 7 最后。

---

## 上下文 / 多窗口接棒说明

开发过程中若对话上下文用满或需要在新窗口继续，可按下面方式接棒，无需完整对话历史。

### 维护「当前工作状态」

- 在项目根目录维护 **`当前工作状态.md`**（可与本开发计划同目录）。
- 每完成一个阶段或暂停时更新该文件，包含：
  - **已完成阶段**：例如「阶段 0、1、2 已完成」；
  - **当前可运行状态**：例如「demo_project 已能启动，执行页可打开」；
  - **下一步**：例如「请从阶段 3 继续」；
  - **待解决问题**（若有）：简短列出。

这样任意新窗口只需读「开发计划 + 需求说明书 + 当前工作状态」即可接着做。

### 新窗口如何接棒

1. 新开一个聊天窗口。
2. 用 **@** 引用本仓库中的：
   - `开发计划.md`
   - `脚本管理与执行标准件-需求说明书.md`
   - 若已存在：`当前工作状态.md`
3. 第一句说明任务，例如：
   - **从头开始**：「请按开发计划从阶段 0 开始执行 script_kit 项目，参考代码在 `G:\django\Article\脚本管理\代码备份\20251118\script_manager`。」
   - **从中途接棒**：「script_kit 已做到阶段 X，请读 当前工作状态.md 和 开发计划.md，从阶段 X+1 继续。」

新窗口不需要本对话的完整历史，有上述文档即可。

### 按阶段拆窗口（可选）

若单窗口容易在开发未完成时占满上下文，可拆成多窗口，例如：

- 窗口 A：阶段 0～3；
- 窗口 B：读 `当前工作状态.md` 后做阶段 4～5；
- 窗口 C：读 `当前工作状态.md` 后做阶段 6～7。

每个新窗口开头都 @ 引用 **开发计划.md**、**需求说明书**、**当前工作状态.md**（若有）。

---

*文档由 AI 维护，有变更直接说明即可更新。*
