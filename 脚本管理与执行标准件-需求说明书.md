# 脚本管理与执行标准件 - 需求说明书

**版本**：v1.0  
**日期**：2025-02  
**目标**：在参考实现（script_manager）基础上，整理为可复用的「脚本管理 + 脚本执行」标准件，便于论文、科研、教学等项目复用与扩展。**本标准件实现名：script_kit**（Django app 名、配置前缀、表前缀均使用 script_kit）。

---

## 一、目标与范围

### 1.1 目标

- 将**脚本管理**与**脚本执行**做成可复用的标准件（Django App 形态），各业务项目（论文管理、科研管理、教学管理等）复用同一套代码，只做配置与脚本内容差异。
- 单项目内：元数据存本项目，不上报到中心；执行入口以**各项目前端**为主。
- 支持**参数预设**、**方便移植**、**预留智能调用与智能查询接口**，便于后续接入 LLM。

### 1.2 范围

- **本期**：标准件功能优化（参数预设、配置化、移植文档）、预留接口（智能调用、智能查询占位）。
- **后续**：接入 LLM 实现智能调用与智能查询；可选跨项目统一视图（非必须）。

### 1.3 术语

| 术语 | 说明 |
|------|------|
| 脚本管理模块 | 负责脚本元数据的维护、查询、导入导出；不执行脚本。 |
| 脚本执行模块 | 负责按 script_id + params 加载并执行脚本，返回统一格式结果；不维护元数据。 |
| 标准件 | 同一套 Django App 代码，可被多个项目安装/复制使用，通过配置适配不同项目。 |
| 参数预设 | 为某脚本保存的常用参数组合，执行时可选「用某预设」快速填参。 |
| 缺省参数 | 每个脚本在数据库中保存的一组默认参数；执行页打开时自动用其填充表单，用户可修改并可选择是否「保存为缺省参数」回写数据库。 |
| dry_run（试运行） | 执行时传入 dry_run=True，涉及数据库写入的脚本不实际写库，只做校验/预览并返回拟执行操作说明，避免误操作。 |

---

## 二、现状摘要（基于现有 script_manager）

### 2.1 已有能力

- **模型**：`ScriptDefinition`（name, description, category, script_file, parameters JSON）、`ScriptExecution`（执行记录：script, status, parameters_used, result, error_message, duration 等）。
- **管理**：脚本 CRUD、按分类/脚本文件扫描、JSON 导入/导出（含批量选中导出）。
- **执行**：`POST /api/execute/` 传入 script_id、params，通过 `importlib` 加载配置的脚本根路径（如 `script_kit.scripts`）下的 `{script_file}` 并调用 `main(params)`，结果写入 `ScriptExecution` 并返回。
- **前端**：执行页（按分类展示脚本、根据 parameters 生成表单、localStorage 记住上次参数）、管理页（列表、新增/编辑/删除、导入/导出）。
- **脚本约定**：脚本提供 `main(params)` 入口；返回 dict，至少含 `status`（success/error）、`message`，常见含 `processed_count`、`error_count`、`warning_count` 等。

### 2.2 待改进点

- 脚本根路径写死为固定包名（如 `script_manager.scripts`），不利于移植到不同项目/包名。
- 无参数预设，常用脚本需每次手填参数。
- 无智能调用/智能查询预留接口。
- 缺少「如何接入新项目」的文档与配置规范。

---

## 三、功能需求

### 3.1 脚本管理模块

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 脚本元数据维护 | 同现有：name, description, category, script_file, parameters（JSON）。支持 CRUD、按分类筛选。 | P0 |
| 脚本发现 | 同现有：可扫描配置的脚本根目录下子目录作为分类，按分类列出可选的 .py 文件供关联。 | P0 |
| 导入/导出 | 同现有：JSON 导入/导出脚本定义（支持全部、按分类、按选中）。 | P0 |
| 参数预设 | **新增**：为每个脚本保存多条「参数预设」（预设名称 + 参数键值对）。执行页可选「加载某预设」自动填充表单。 | P0 |
| 缺省参数（数据库） | **新增**：每个脚本在数据库中保存一组「缺省参数」。执行页打开时**自动读取**该脚本的缺省参数填充表单；用户在执行页修改参数后，可**选择**「保存为缺省参数」写回数据库，也可不保存。便于在管理后台按脚本注册信息快速定位并修改常用参数。 | P0 |
| 配置化脚本根目录 | **新增**：脚本根目录由配置指定（如 `settings.SCRIPT_KIT_SCRIPTS_ROOT`，默认 `script_kit.scripts`），执行与扫描均基于该配置，不写死包名。 | P0 |

### 3.2 脚本执行模块

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 执行接口 | 同现有：接收 script_id、params，加载脚本并调用 `main(params)`，写执行记录并返回结果。 | P0 |
| 执行记录 | 同现有：记录 status、parameters_used、result、error_message、duration、completed_at 等。 | P0 |
| 超时与异常 | 建议：支持可配置的执行超时；异常时统一写入 error_message 并返回 500。 | P1 |
| 参数预设参与执行 | 执行时若前端传入「预设 id」或「预设名称」，后端可解析为对应参数再执行（可选实现方式：前端用预设填参后仍传 params）。 | P1 |
| 试运行模式（dry_run） | **新增**：执行接口支持在 params 中传入 `dry_run`（布尔）。执行框架将 params 原样传给脚本。**凡涉及数据库写入的脚本**，必须在脚本内部检查 `dry_run`：当 `dry_run=True` 时不执行实际写库，只做校验/统计/预览，并在返回结果中说明拟执行的操作或影响行数；当 `dry_run=False` 或未传时才真正写库。标准件文档中明确约定，供脚本作者遵守。 | P0 |

### 3.3 前端

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 执行页 | 同现有：分类 + 脚本列表、按 parameters 生成表单、提交执行、展示结果。 | P0 |
| 执行页 - 缺省参数 | **新增**：打开执行页并选择某脚本后，**自动从数据库读取该脚本的缺省参数**填充表单（若无则用脚本 definition 中的 default）。用户修改参数并执行后，提供**可选**「保存为缺省参数」选项（如勾选框或按钮）；用户若勾选/点击，则将当前参数写回该脚本在数据库中的缺省参数，否则不保存。 | P0 |
| 执行页 - 参数预设 | **新增**：选择脚本后可选「加载预设」下拉框，选择后填充表单；支持「保存当前参数为预设」。 | P0 |
| 执行页 - 试运行 | **新增**：提供「试运行」勾选框；勾选时本次执行的 params 中带 `dry_run=True`，不实际写库（由脚本内部遵守约定）。 | P0 |
| 管理页 | 同现有：脚本列表、新增/编辑/删除、导入/导出。 | P0 |
| 管理页 - 参数预设 | **新增**：在脚本详情/编辑中可管理该脚本的参数预设（列表、新增、删除）。 | P0 |
| 使用配置的根路径 | 前端不直接依赖包名；后端 API 已基于配置根路径，前端无需改。 | P0 |

### 3.4 移植与扩展

| 需求 | 说明 | 优先级 |
|------|------|--------|
| 配置项 | 在项目 `settings` 或 app 默认配置中提供：脚本根目录（如 `SCRIPT_KIT_SCRIPTS_ROOT = 'script_kit.scripts'` 或项目自定义）、可选：执行超时时间、是否启用参数预设。 | P0 |
| 表名与命名空间 | 保持 `db_table` 前缀（如 `script_kit_definition`），模板/静态使用 `script_kit/` 命名空间，避免与业务 app 冲突。 | P0 |
| 依赖 | 标准件尽量不依赖项目特有 model（如自定义 User）；若需「执行人」，建议可选或使用 `settings.AUTH_USER_MODEL`。 | P0 |
| 接入文档 | 提供一页「接入说明」：INSTALLED_APPS、url 挂载、必须/可选配置、脚本目录结构约定、首次迁移与使用步骤。 | P0 |

### 3.5 预留接口（本期仅占位）

| 接口 | 说明 | 本期实现 |
|------|------|----------|
| 智能调用 | 按自然语言描述执行脚本。请求体如 `{"description": "用户描述"}`。 | 返回 501 或固定文案「预留，后续由 LLM 解析为 script_id + params 并调用执行」。 |
| 智能查询 | 简单只读查询由 LLM 动态生成（不预定义脚本）。请求体如 `{"query": "用户自然语言查询"}`。 | 返回 501 或固定文案「预留，后续由 LLM 生成只读查询并执行」。 |

上述两个接口需在文档中约定：请求/响应格式、后续实现方向（智能调用：选脚本+填参；智能查询：只读、白名单表/字段、超时与行数限制）。

---

## 四、数据需求

### 4.1 现有模型（保留）

- **ScriptDefinition**：name, description, category, script_file, parameters（JSON）, **default_parameters（JSON，可选）**——该脚本的缺省参数键值对，执行页打开时用于填充表单；created_at, updated_at；表名 `script_kit_definition`。
- **ScriptExecution**：script FK, status, parameters_used, result, error_message, created_at, completed_at, duration；表名 `script_kit_execution`。

### 4.2 新增模型

- **ScriptParameterPreset（参数预设）**
  - 字段：script（FK ScriptDefinition, related_name='parameter_presets'）, name（预设名称）, parameters（JSON，参数键值对）, created_at, updated_at。
  - 约束：同一 script 下 name 唯一（unique_together 或 UniqueConstraint）。
  - 表名：`script_kit_parameter_preset`。

### 4.3 脚本返回值约定（与现有一致）

- 至少包含：`status`（'success' | 'error'）, `message`（字符串）。
- 建议包含：`processed_count`, `error_count`, `warning_count` 等，便于前端统一展示。
- 执行模块将脚本返回的 dict 原样写入 `ScriptExecution.result` 并返回给前端。

---

## 五、接口与约定

### 5.1 脚本根目录配置

- 配置键：`SCRIPT_KIT_SCRIPTS_ROOT`（由 app 的 default_settings 提供默认值）。
- 值示例：`'script_kit.scripts'` 或 `'my_project.scripts'`。
- 执行时：`importlib.import_module(f'{root}.{script_def.script_file}')`；扫描分类时：基于该 root 对应的文件系统路径或包路径解析子目录。

### 5.2 脚本文件约定

- `script_file` 格式：`category.module_name`（如 `file_operations.merge_json`），对应 `{scripts_root}/{category}/{module_name}.py`。
- 每个脚本提供 `main(params: dict) -> dict`，参数与返回值符合 4.3。
- **涉及数据库写入的脚本**：必须支持 params 中的 `dry_run`（bool）。当 `dry_run=True` 时，不执行实际 INSERT/UPDATE/DELETE，只做校验、统计或预览，并在返回的 `message` 或扩展字段中说明拟执行的操作（如影响行数、样例数据）；当 `dry_run=False` 或未传时正常写库。执行框架不解析 dry_run，只透传 params。

### 5.3 API 清单（保留 + 新增）

- 保留：执行页/管理页、api/scripts/、api/script/<id>/、api/execute/、api/scripts-list/、api/execution/<id>/、api/categories/、api/categories-available/、api/script-files/<category>/、api/import-scripts/、api/export-scripts/。
- 新增（示例）：
  - 参数预设：`GET/POST api/script/<id>/presets/`，`GET/PUT/DELETE api/script/<id>/presets/<preset_id>/`（或合并到 script 详情的子资源）。
  - 缺省参数：`GET api/script/<id>/default-parameters/` 返回该脚本的缺省参数；`PUT api/script/<id>/default-parameters/` 或 `POST api/script/<id>/save-default-parameters/` 接收 body 中的参数键值对，更新该脚本的 default_parameters 并返回成功。
  - 执行接口：请求体中的 `params` 可包含 `dry_run`（bool），执行框架原样传入 `main(params)`。
  - 预留：`POST api/execute-by-description/`，`POST api/query-by-description/`（或统一为 `api/smart/...`），本期返回 501 与说明文案。

---

## 六、非功能需求

- **兼容性**：在参考实现 script_manager 基础上扩展为 script_kit，不破坏执行页、管理页与 API 的常规使用。
- **可移植性**：新项目通过复制/安装 app、配置根路径与 url、执行迁移即可使用。
- **可维护性**：标准件与业务解耦，业务只依赖配置与脚本目录结构；文档清晰，便于后续接入 LLM 与智能查询。

---

## 七、交付物与测试要求

### 7.0 交付物

- **标准件 app**：脚本管理与执行标准件（Django App）的完整代码。
- **测试用 Django 项目**：一个可运行的、用于测试标准件的 Django 项目（可为空项目，仅包含必要配置并挂载该 app）。因标准件必须挂载在某个 project 下才能运行，单独的标准件无法自测，故交付物中应包含此测试项目，便于开发与验收时运行、调试。
- **自带测试脚本**：标准件或测试项目内应自带若干条**用于功能测试的示例脚本**，满足：
  - **至少两个脚本目录**（两个 category，如 `file_operations`、`data_processing`）；
  - **每个目录下至少两个脚本文件**（即至少 4 个脚本）。
  - 用于验证：分类展示、脚本列表、参数表单、执行、执行记录、缺省参数读写、参数预设、dry_run（若某脚本涉及写库可做试运行示例）等。脚本逻辑可简单（如只读参数并返回统计信息），无需复杂业务。
- **接入文档**：新项目如何接入标准件的说明（见 3.4）。

### 7.1 本期验收要点

- 缺省参数：脚本在数据库中有缺省参数字段；执行页打开时自动用其填充表单；用户执行后可选择「保存为缺省参数」写回数据库；管理后台可查看/编辑缺省参数。
- 参数预设：可为脚本保存多条预设，执行页可选预设并填充参数；管理页可管理预设。
- 试运行（dry_run）：执行页可勾选试运行；params 带 dry_run=True 时，涉及写库的脚本不实际写库并返回拟执行说明；文档中约定脚本作者对 dry_run 的遵守规范。
- 配置化根路径：修改配置后，执行与分类扫描均使用新根路径，无需改代码。
- 预留接口：智能调用、智能查询两个接口存在且返回明确占位说明。
- 接入文档：新项目按文档可完成接入并运行执行页/管理页。
- 测试项目与测试脚本：测试用 Django 项目可正常启动并访问执行页/管理页；自带测试脚本至少 2 个目录、每目录至少 2 个脚本，且能完成列表、执行、缺省参数、预设等基本流程验证。

### 7.2 后续可选

- 接入 LLM：实现智能调用（description → script_id + params）、智能查询（只读、安全约束）。
- 跨项目统一视图：若需「全院脚本一览」，再考虑中心化注册与门户聚合。

---

## 八、参考

- **本标准件项目路径**：`G:\cursor\projects\script_kit`，Django app 名：`script_kit`。
- **参考实现路径**：`G:\django\Article\脚本管理\代码备份\20251118\script_manager`。
- 讨论结论：单项目内标准件、执行入口以项目前端为主、参数预设与移植优化、预留智能接口。
