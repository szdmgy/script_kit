# script_kit 当前工作状态

**最后更新**：阶段 6 已完成。

---

## 已完成阶段

- **阶段 0**：`.gitignore`、`requirements.txt`、Dockerfile/docker-compose；Git 已由您本地初始化。
- **阶段 1**：script_kit 骨架、templates/scripts、demo_project、SCRIPT_KIT_SCRIPTS_ROOT、根路径重定向。
- **阶段 2**
  - **ScriptDefinition** 已增加 `default_parameters`（JSONField，default=dict，blank=True）；表名 `script_kit_definition`。
  - **ScriptExecution** 已存在，表名 `script_kit_execution`。
  - **ScriptParameterPreset** 已新增：script（FK）、name、parameters（JSON）、created_at、updated_at；同一 script 下 name 唯一；表名 `script_kit_parameter_preset`。
  - 已创建 `script_kit/migrations/0001_initial.py`；admin 已注册三张表并支持 default_parameters 与预设管理。
- **阶段 3**
  - **get_scripts_root()**：`script_kit/conf.py` 中实现，从 `settings.SCRIPT_KIT_SCRIPTS_ROOT` 读取，默认 `'script_kit.scripts'`。
  - **动态 import**：`script_kit/runner.py` 中 `run_script(script_def, params)` 使用 `importlib.import_module(f'{root}.{script_def.script_file}')` 并调用 `main(params)`。
  - **扫描**：`script_kit/scan.py` 中 `get_categories()`、`get_script_files(category)` 基于 root 包做 pkgutil 扫描，供后续 API 使用。
- **阶段 4**
  - **后端 API**：`script_kit/api.py` 实现全部接口，纯 Django JsonResponse，无 DRF 依赖。
  - Scripts CRUD：`api/scripts/`（GET 列表/POST 创建）、`api/script/<id>/`（GET/PUT/DELETE）、`api/scripts-list/`（精简列表）。
  - 执行：`api/execute/`（POST，params 含 dry_run 透传 main）；`api/execution/<id>/`（GET 执行记录详情）。
  - 缺省参数：`api/script/<id>/default-parameters/`（GET/PUT）。
  - 参数预设：`api/script/<id>/presets/`（GET/POST）、`api/script/<id>/presets/<preset_id>/`（GET/PUT/DELETE）。
  - 扫描：`api/categories/`（DB）、`api/categories-available/`（文件系统）、`api/script-files/<category>/`。
  - 导入导出：`api/import-scripts/`（POST）、`api/export-scripts/`（GET）。
  - 预留：`api/execute-by-description/`、`api/query-by-description/` 返回 501。
  - URL 全部注册在 `script_kit/urls.py`，Django check 无问题，关键接口用 RequestFactory 验证通过。
- **阶段 5**
  - **base.html**：公共布局（topbar 导航、CSS 变量、卡片/表格/按钮/模态框等通用样式、apiFetch 封装）。
  - **执行页 index.html**：分类→脚本→预设三级联动；根据 parameters 配置和 default_parameters 动态生成参数表单；dry_run 勾选；执行→显示结果（状态/耗时/结果 JSON）；保存为缺省参数；保存为预设。
  - **管理页 manage.html**：脚本列表表格；新建/编辑弹窗（名称、分类、脚本文件、描述、参数配置 JSON、缺省参数 JSON）；分类与脚本文件 datalist 建议（从文件系统扫描）；预设管理（列表、新增、删除）；导入/导出。
  - Django check 无问题，Test Client 验证：执行页 200、管理页 302（需登录，预期行为）、API 200。
- **阶段 6**
  - `script_kit/scripts/file_operations/`：`list_files.py`（列出目录文件）、`file_info.py`（文件详情）。
  - `script_kit/scripts/data_processing/`：`merge_json.py`（合并 JSON，支持 dry_run）、`csv_summary.py`（CSV 统计摘要）。
  - management command `init_scripts`：幂等初始化 4 条 ScriptDefinition（get_or_create）。
  - 验证：`get_categories()` 返回 2 类，`get_script_files()` 每类 2 个；`run_script()` 执行 3 个脚本均正常。

---

## 当前可运行状态

**环境约定：禁止使用全局 Python。** 所有运行/迁移必须在 **项目 venv** 或 **Docker** 内执行。

- **应用迁移**：在仓库根目录先激活 venv（或使用下面的 `run_migrate.bat`），再执行 `python demo_project/manage.py migrate`。或使用 Docker：`docker-compose up` 前若需迁移，可先 `docker-compose run web python manage.py migrate`。
- **启动服务**：使用 **`run_local.bat`**（自动创建/激活 venv、安装依赖并启动），或 **`docker-compose up`**。访问 http://127.0.0.1:8000/script-kit/、/script-kit/manage/。

---

## 下一步

- 从 **阶段 7** 开始：接入文档与收尾（接入说明、整体检查、全流程跑通）。

---

## 待解决问题

- 无。
