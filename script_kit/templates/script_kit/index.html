{% extends "script_kit/base.html" %}
{% block title %}脚本执行 - script_kit{% endblock %}
{% block nav_exec %}class="active"{% endblock %}

{% block content %}
<!-- 脚本选择 -->
<div class="card">
    <h2>选择脚本</h2>
    <div class="form-row">
        <div>
            <label for="sel-category">分类</label>
            <select id="sel-category"><option value="">-- 选择分类 --</option></select>
        </div>
        <div>
            <label for="sel-script">脚本</label>
            <select id="sel-script" disabled><option value="">-- 先选分类 --</option></select>
        </div>
        <div>
            <label for="sel-preset">参数预设</label>
            <select id="sel-preset" disabled><option value="">-- 默认 --</option></select>
        </div>
    </div>
    <p id="script-desc" class="text-muted"></p>
</div>

<!-- 参数表单 -->
<div id="params-card" class="card hidden">
    <div class="flex-between mb-12">
        <h2>参数</h2>
        <label style="display:inline-flex;align-items:center;gap:6px;margin:0;font-weight:normal;cursor:pointer;">
            <input type="checkbox" id="chk-dryrun"> 试运行 (dry_run)
        </label>
    </div>
    <div id="params-form"></div>
    <div class="btn-group">
        <button class="btn btn-primary" id="btn-execute" onclick="doExecute()">执行</button>
        <button class="btn btn-outline btn-sm" onclick="saveAsDefault()">保存为缺省参数</button>
        <button class="btn btn-outline btn-sm" onclick="promptSavePreset()">保存为预设</button>
    </div>
</div>

<!-- 执行结果 -->
<div id="result-card" class="card hidden">
    <div class="flex-between">
        <h2>执行结果</h2>
        <span id="result-status"></span>
    </div>
    <div id="result-box" class="result-box"></div>
    <p id="result-meta" class="text-muted mt-8"></p>
</div>
{% endblock %}

{% block extra_js %}
<script>
const selCat = document.getElementById('sel-category');
const selScript = document.getElementById('sel-script');
const selPreset = document.getElementById('sel-preset');
const paramsCard = document.getElementById('params-card');
const paramsForm = document.getElementById('params-form');
const resultCard = document.getElementById('result-card');
const resultBox = document.getElementById('result-box');
const resultStatus = document.getElementById('result-status');
const resultMeta = document.getElementById('result-meta');
const scriptDesc = document.getElementById('script-desc');

let allScripts = [];
let currentScript = null;
let currentPresets = [];

async function init() {
    allScripts = await apiFetch('/scripts/');
    const cats = [...new Set(allScripts.map(s => s.category))].sort();
    selCat.innerHTML = '<option value="">-- 选择分类 --</option>' +
        cats.map(c => `<option value="${c}">${c}</option>`).join('');
}

selCat.addEventListener('change', () => {
    const cat = selCat.value;
    const filtered = allScripts.filter(s => s.category === cat);
    selScript.disabled = !cat;
    selScript.innerHTML = '<option value="">-- 选择脚本 --</option>' +
        filtered.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    selPreset.disabled = true;
    selPreset.innerHTML = '<option value="">-- 默认 --</option>';
    paramsCard.classList.add('hidden');
    resultCard.classList.add('hidden');
    scriptDesc.textContent = '';
    currentScript = null;
});

selScript.addEventListener('change', async () => {
    const sid = selScript.value;
    if (!sid) { paramsCard.classList.add('hidden'); currentScript = null; return; }
    currentScript = allScripts.find(s => s.id == sid);
    scriptDesc.textContent = currentScript.description || '';
    await loadPresets(sid);
    fillParams(currentScript.default_parameters);
    paramsCard.classList.remove('hidden');
    resultCard.classList.add('hidden');
});

selPreset.addEventListener('change', () => {
    const pid = selPreset.value;
    if (!pid) { fillParams(currentScript.default_parameters); return; }
    const preset = currentPresets.find(p => p.id == pid);
    if (preset) fillParams(preset.parameters);
});

async function loadPresets(scriptId) {
    currentPresets = await apiFetch(`/script/${scriptId}/presets/`);
    selPreset.disabled = false;
    selPreset.innerHTML = '<option value="">-- 默认 --</option>' +
        currentPresets.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
}

function fillParams(defaults) {
    defaults = defaults || {};
    const paramsCfg = currentScript.parameters || {};
    const keys = Object.keys(paramsCfg);
    if (keys.length === 0 && Object.keys(defaults).length === 0) {
        paramsForm.innerHTML = '<p class="text-muted">此脚本无参数配置，可直接执行。</p>';
        return;
    }
    let html = '';
    const allKeys = [...new Set([...keys, ...Object.keys(defaults)])];
    allKeys.forEach(k => {
        const cfg = paramsCfg[k] || {};
        const val = defaults[k] !== undefined ? defaults[k] : (cfg.default !== undefined ? cfg.default : '');
        const desc = cfg.description || '';
        const type = cfg.type || 'text';
        const inputType = type === 'number' ? 'number' : 'text';
        html += `<div class="form-group">
            <label>${k}${cfg.required ? ' *' : ''}${desc ? ' — ' + desc : ''}</label>
            <input type="${inputType}" name="${k}" value="${typeof val === 'object' ? JSON.stringify(val) : val}" data-type="${type}">
        </div>`;
    });
    paramsForm.innerHTML = html;
}

function collectParams() {
    const params = {};
    paramsForm.querySelectorAll('input[name]').forEach(el => {
        let val = el.value;
        const type = el.dataset.type;
        if (type === 'number') val = Number(val);
        else { try { val = JSON.parse(val); } catch(_) {} }
        params[el.name] = val;
    });
    if (document.getElementById('chk-dryrun').checked) params.dry_run = true;
    return params;
}

async function doExecute() {
    if (!currentScript) return;
    const btn = document.getElementById('btn-execute');
    btn.disabled = true; btn.textContent = '执行中…';
    resultCard.classList.remove('hidden');
    resultBox.textContent = '正在执行，请稍候…';
    resultStatus.innerHTML = '<span class="badge badge-warning">running</span>';
    resultMeta.textContent = '';

    try {
        const res = await apiFetch('/execute/', {
            method: 'POST',
            body: { script_id: currentScript.id, params: collectParams() },
        });
        const statusBadge = res.status === 'completed'
            ? '<span class="badge badge-success">完成</span>'
            : '<span class="badge badge-danger">失败</span>';
        resultStatus.innerHTML = statusBadge;
        resultBox.textContent = res.status === 'completed'
            ? JSON.stringify(res.result, null, 2)
            : (res.error_message || JSON.stringify(res, null, 2));
        resultMeta.textContent = `耗时 ${res.duration?.toFixed(2) || '?'}s | 执行 ID: ${res.id}`;
    } catch (e) {
        resultStatus.innerHTML = '<span class="badge badge-danger">错误</span>';
        resultBox.textContent = e.toString();
    } finally {
        btn.disabled = false; btn.textContent = '执行';
    }
}

async function saveAsDefault() {
    if (!currentScript) return;
    const params = collectParams();
    delete params.dry_run;
    await apiFetch(`/script/${currentScript.id}/default-parameters/`, {
        method: 'PUT', body: { default_parameters: params },
    });
    currentScript.default_parameters = params;
    alert('已保存为缺省参数');
}

function promptSavePreset() {
    const name = prompt('请输入预设名称：');
    if (!name) return;
    const params = collectParams();
    delete params.dry_run;
    apiFetch(`/script/${currentScript.id}/presets/`, {
        method: 'POST', body: { name, parameters: params },
    }).then(() => { loadPresets(currentScript.id); alert('预设已保存'); });
}

init();
</script>
{% endblock %}
