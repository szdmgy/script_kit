{% extends "script_kit/base.html" %}
{% block title %}【脚本执行器】{% endblock %}
{% block nav_exec %}class="active"{% endblock %}

{% block sidebar %}
<h3>脚本分类</h3>
<ul id="cat-list">
    <li class="active" data-cat="">全部</li>
</ul>
{% endblock %}

{% block content %}
<h2 style="font-size:30px;font-weight:700;margin-bottom:6px;">【脚本执行器】</h2>
<p class="text-muted" style="margin-bottom:24px;">在局域网内，服务器可以直接访问用户电脑上的指定目录进行文件操作</p>
<div id="scripts-area"></div>
{% endblock %}

{% block extra_js %}
<script>
const catList = document.getElementById('cat-list');
const area = document.getElementById('scripts-area');
let allScripts = [];
let currentCat = '';

async function init() {
    allScripts = await apiFetch('/scripts/');
    const cats = [...new Set(allScripts.map(s => s.category))].sort();
    catList.innerHTML = '<li class="active" data-cat="">全部</li>' +
        cats.map(c => `<li data-cat="${c}">${c}</li>`).join('');
    catList.querySelectorAll('li').forEach(li => {
        li.addEventListener('click', () => {
            catList.querySelector('.active')?.classList.remove('active');
            li.classList.add('active');
            currentCat = li.dataset.cat;
            render();
        });
    });
    render();
}

function render() {
    const filtered = currentCat ? allScripts.filter(s => s.category === currentCat) : allScripts;
    if (filtered.length === 0) {
        area.innerHTML = '<p class="text-muted" style="padding:20px;">暂无脚本。</p>';
        return;
    }
    const grouped = {};
    filtered.forEach(s => {
        if (!grouped[s.category]) grouped[s.category] = [];
        grouped[s.category].push(s);
    });
    let html = '';
    for (const cat of Object.keys(grouped).sort()) {
        html += `<div class="category-title">分类: ${esc(cat)}</div>`;
        grouped[cat].forEach(s => { html += renderCard(s); });
    }
    area.innerHTML = html;
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function renderCard(s) {
    const paramsCfg = s.parameters || {};
    const defaults = s.default_parameters || {};
    const allKeys = [...new Set([...Object.keys(paramsCfg), ...Object.keys(defaults)])];

    let paramsHtml = '';
    allKeys.forEach(k => {
        if (k === 'dry_run') return;
        const cfg = paramsCfg[k] || {};
        const val = defaults[k] !== undefined ? defaults[k] : (cfg.default !== undefined ? cfg.default : '');
        const displayVal = typeof val === 'object' ? JSON.stringify(val) : val;
        paramsHtml += `<label>${esc(k)}:</label>
            <input type="text" id="p-${s.id}-${k}" value="${esc(String(displayVal))}" data-key="${k}" data-type="${cfg.type || 'text'}">`;
    });

    paramsHtml += `<label>dry_run:</label>
        <div class="chk-wrap"><input type="checkbox" id="p-${s.id}-dry_run"></div>`;

    return `<div class="script-card" id="card-${s.id}">
        <h3>${esc(s.name)} <span class="badge badge-pending" id="status-${s.id}">待执行</span></h3>
        <div class="desc"><strong>描述:</strong> ${esc(s.description || '无')}</div>
        <div class="params-grid">${paramsHtml}</div>
        <div class="btn-group">
            <button class="btn btn-green" onclick="doExec(${s.id})">执行脚本</button>
            <button class="btn btn-orange" onclick="toggleDetail(${s.id})">查看参数详情</button>
            <button class="btn btn-outline" onclick="saveDefault(${s.id})">保存为缺省参数</button>
        </div>
        <div id="detail-${s.id}" class="hidden" style="margin-top:12px;">
            <div class="text-muted">参数配置：</div>
            <pre style="background:#f5f5f5;padding:10px;border-radius:4px;font-size:17px;max-height:250px;overflow:auto;">${esc(JSON.stringify(s.parameters, null, 2))}</pre>
        </div>
        <div id="result-${s.id}" class="hidden"></div>
    </div>`;
}

function toggleDetail(id) {
    document.getElementById('detail-' + id)?.classList.toggle('hidden');
}

function collectParams(id) {
    const card = document.getElementById('card-' + id);
    const params = {};
    card.querySelectorAll('.params-grid input[type="text"]').forEach(el => {
        let val = el.value;
        const type = el.dataset.type;
        if (type === 'number') val = Number(val);
        else { try { val = JSON.parse(val); } catch(_) {} }
        params[el.dataset.key] = val;
    });
    const chk = document.getElementById('p-' + id + '-dry_run');
    if (chk && chk.checked) params.dry_run = true;
    return params;
}

async function doExec(id) {
    const badge = document.getElementById('status-' + id);
    const resultDiv = document.getElementById('result-' + id);
    badge.className = 'badge badge-running';
    badge.textContent = '执行中…';
    resultDiv.classList.remove('hidden');
    resultDiv.innerHTML = '<div class="result-block">正在执行，请稍候…</div>';

    const params = collectParams(id);
    const res = await apiFetch('/execute/', { method: 'POST', body: { script_id: id, params } });

    if (res.status === 'completed') {
        badge.className = 'badge badge-success';
        badge.textContent = '执行成功';
        resultDiv.innerHTML = `<div class="result-block">${esc(JSON.stringify(res.result, null, 2))}</div>
            <div class="text-muted mt-8">耗时 ${res.duration?.toFixed(2) || '?'}s | 执行ID: ${res.id}</div>`;
    } else {
        badge.className = 'badge badge-fail';
        badge.textContent = '执行失败';
        resultDiv.innerHTML = `<div class="result-block" style="color:#f38ba8;">${esc(res.error_message || JSON.stringify(res, null, 2))}</div>`;
    }
}

async function saveDefault(id) {
    const params = collectParams(id);
    delete params.dry_run;
    await apiFetch(`/script/${id}/default-parameters/`, { method: 'PUT', body: { default_parameters: params } });
    const s = allScripts.find(x => x.id === id);
    if (s) s.default_parameters = params;
    alert('已保存为缺省参数');
}

init();
</script>
{% endblock %}
