{% extends "script_kit/base.html" %}
{% block title %}【脚本管理后台】{% endblock %}
{% block nav_manage %}class="active"{% endblock %}

{% block sidebar %}
<h3>管理选项</h3>
<ul>
    <li class="active" style="font-weight:700;">管理脚本</li>
</ul>
<div class="section-title">分类筛选</div>
<ul id="cat-list">
    <li class="active" data-cat="">全部</li>
</ul>
{% endblock %}

{% block content %}
<h2 style="font-size:30px;font-weight:700;margin-bottom:20px;">【脚本管理后台】</h2>

<div class="toolbar">
    <button class="btn btn-primary" onclick="showCreate()">+ 添加脚本</button>
    <button class="btn btn-green" onclick="loadScripts()">刷新列表</button>
    <button class="btn btn-blue" onclick="exportSelected()">导出选中</button>
    <a class="btn btn-blue" href="{% url 'script_kit:api_export_scripts' %}" target="_blank" style="text-decoration:none;">导出全部</a>
    <label class="btn btn-orange" style="cursor:pointer;">
        导入脚本
        <input type="file" accept=".json" id="import-file" style="display:none;" onchange="handleImportFile(this)">
    </label>
</div>

<table>
    <thead>
        <tr>
            <th style="width:36px;"><input type="checkbox" id="chk-all" onchange="toggleAll(this)" style="width:20px;height:20px;"></th>
            <th style="width:60px;">ID</th>
            <th>脚本名称</th>
            <th>分类</th>
            <th>描述</th>
            <th style="width:100px;">操作</th>
        </tr>
    </thead>
    <tbody id="scripts-tbody">
        <tr><td colspan="6" class="text-muted" style="text-align:center;">加载中…</td></tr>
    </tbody>
</table>

<!-- 新建/编辑弹窗 -->
<div id="modal-overlay" class="modal-overlay hidden" onclick="if(event.target===this)closeModal()">
    <div class="modal">
        <h3 id="modal-title">添加脚本</h3>
        <input type="hidden" id="edit-id">
        <div class="form-group"><label>名称 *</label><input type="text" id="edit-name"></div>
        <div class="form-row">
            <div class="form-group"><label>分类 *</label><input type="text" id="edit-category" list="cat-dl"><datalist id="cat-dl"></datalist></div>
            <div class="form-group"><label>脚本文件 *</label><input type="text" id="edit-script-file" placeholder="category.module" list="file-dl"><datalist id="file-dl"></datalist></div>
        </div>
        <div class="form-group"><label>描述</label><textarea id="edit-desc" rows="4"></textarea></div>
        <div class="form-group"><label>参数配置 (JSON)</label><textarea id="edit-params" rows="10"></textarea></div>
        <div class="form-group"><label>缺省参数 (JSON)</label><textarea id="edit-defaults" rows="6"></textarea></div>
        <div class="btn-group" style="margin-top:20px;">
            <button class="btn btn-green" onclick="saveScript()">保存</button>
            <button class="btn btn-outline" onclick="closeModal()">取消</button>
            <button class="btn btn-red hidden" id="btn-del" onclick="delScript()">删除脚本</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const catList = document.getElementById('cat-list');
const tbody = document.getElementById('scripts-tbody');
let allScripts = [];
let currentCat = '';

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

async function loadScripts() {
    allScripts = await apiFetch('/scripts/');
    const cats = [...new Set(allScripts.map(s => s.category))].sort();
    catList.innerHTML = '<li class="active" data-cat="">全部</li>' +
        cats.map(c => `<li data-cat="${c}">${c}</li>`).join('');
    catList.querySelectorAll('li').forEach(li => {
        li.addEventListener('click', () => {
            catList.querySelector('.active')?.classList.remove('active');
            li.classList.add('active');
            currentCat = li.dataset.cat;
            renderTable();
        });
    });
    renderTable();
}

function renderTable() {
    const filtered = currentCat ? allScripts.filter(s => s.category === currentCat) : allScripts;
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-muted" style="text-align:center;">暂无脚本，点击「添加脚本」创建。</td></tr>';
        return;
    }
    tbody.innerHTML = filtered.map(s => `<tr>
        <td><input type="checkbox" class="row-chk" value="${s.id}" style="width:20px;height:20px;"></td>
        <td>${s.id}</td>
        <td><strong style="cursor:pointer;color:var(--primary);" onclick="editScript(${s.id})">${esc(s.name)}</strong></td>
        <td>${esc(s.category)}</td>
        <td class="text-muted">${esc((s.description || '').substring(0, 80))}${(s.description || '').length > 80 ? '…' : ''}</td>
        <td><button class="btn btn-outline btn-sm" onclick="editScript(${s.id})">编辑</button></td>
    </tr>`).join('');
}

function toggleAll(el) { document.querySelectorAll('.row-chk').forEach(c => c.checked = el.checked); }

function getSelected() { return [...document.querySelectorAll('.row-chk:checked')].map(c => Number(c.value)); }

function exportSelected() {
    const ids = getSelected();
    if (!ids.length) { alert('请先勾选要导出的脚本'); return; }
    const data = allScripts.filter(s => ids.includes(s.id));
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'scripts_export.json';
    a.click();
}

function showCreate() {
    document.getElementById('modal-title').textContent = '添加脚本';
    document.getElementById('edit-id').value = '';
    document.getElementById('edit-name').value = '';
    document.getElementById('edit-category').value = '';
    document.getElementById('edit-script-file').value = '';
    document.getElementById('edit-desc').value = '';
    document.getElementById('edit-params').value = '{}';
    document.getElementById('edit-defaults').value = '{}';
    document.getElementById('btn-del').classList.add('hidden');
    document.getElementById('modal-overlay').classList.remove('hidden');
    loadSuggestions();
}

async function editScript(id) {
    const s = await apiFetch(`/script/${id}/`);
    document.getElementById('modal-title').textContent = '编辑脚本';
    document.getElementById('edit-id').value = s.id;
    document.getElementById('edit-name').value = s.name;
    document.getElementById('edit-category').value = s.category;
    document.getElementById('edit-script-file').value = s.script_file;
    document.getElementById('edit-desc').value = s.description || '';
    document.getElementById('edit-params').value = JSON.stringify(s.parameters, null, 2);
    document.getElementById('edit-defaults').value = JSON.stringify(s.default_parameters, null, 2);
    document.getElementById('btn-del').classList.remove('hidden');
    document.getElementById('modal-overlay').classList.remove('hidden');
    loadSuggestions();
}

async function loadSuggestions() {
    const cats = await apiFetch('/categories-available/');
    document.getElementById('cat-dl').innerHTML = cats.map(c => `<option value="${c}">`).join('');
}

document.getElementById('edit-category').addEventListener('input', async function() {
    if (!this.value) return;
    const files = await apiFetch(`/script-files/${encodeURIComponent(this.value)}/`);
    document.getElementById('file-dl').innerHTML = files.map(f => `<option value="${this.value}.${f}">`).join('');
});

function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }

async function saveScript() {
    let params, defaults;
    try { params = JSON.parse(document.getElementById('edit-params').value || '{}'); } catch(e) { alert('参数配置 JSON 格式错误'); return; }
    try { defaults = JSON.parse(document.getElementById('edit-defaults').value || '{}'); } catch(e) { alert('缺省参数 JSON 格式错误'); return; }
    const body = {
        name: document.getElementById('edit-name').value,
        category: document.getElementById('edit-category').value,
        script_file: document.getElementById('edit-script-file').value,
        description: document.getElementById('edit-desc').value,
        parameters: params, default_parameters: defaults,
    };
    const eid = document.getElementById('edit-id').value;
    if (eid) await apiFetch(`/script/${eid}/`, { method: 'PUT', body });
    else await apiFetch('/scripts/', { method: 'POST', body });
    closeModal();
    loadScripts();
}

async function delScript() {
    const eid = document.getElementById('edit-id').value;
    if (!eid || !confirm('确认删除此脚本？')) return;
    await apiFetch(`/script/${eid}/`, { method: 'DELETE' });
    closeModal();
    loadScripts();
}

function handleImportFile(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        let data;
        try { data = JSON.parse(e.target.result); } catch(err) { alert('文件内容不是有效 JSON'); return; }
        if (!Array.isArray(data)) data = [data];
        const res = await apiFetch('/import-scripts/', { method: 'POST', body: data });
        alert(`导入完成：成功 ${res.created?.length || 0} 条，失败 ${res.errors?.length || 0} 条`);
        loadScripts();
    };
    reader.readAsText(file, 'utf-8');
    input.value = '';
}

loadScripts();
</script>
{% endblock %}
